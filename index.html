<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>í•™ì›ê°€ì - ìë…€ìš©</title>
    <link rel="manifest" href="manifest.json">
    
    <!-- Gmarket Sans Font -->
    <style>
        @font-face {
            font-family: 'GmarketSans';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2001@1.1/GmarketSansMedium.woff') format('woff');
            font-weight: 400;
            font-style: normal;
        }
    </style>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'GmarketSans', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 100px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
        }

        /* Onboarding Styles */
        .onboarding {
            background: white;
            border-radius: 20px;
            padding: 40px 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .onboarding-title {
            font-size: 28px;
            color: #667eea;
            margin-bottom: 10px;
        }

        .onboarding-subtitle {
            font-size: 16px;
            color: #666;
            margin-bottom: 30px;
        }

        .family-code-section {
            margin-bottom: 30px;
        }

        .family-code-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            text-align: left;
        }

        .family-code-input {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .family-code-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .family-code-help {
            font-size: 12px;
            color: #999;
            margin-top: 10px;
        }

        .children-list {
            margin-top: 30px;
        }

        .child-option {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .child-option:hover {
            background: #eef0ff;
            transform: translateY(-2px);
        }

        .child-option.selected {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }

        .child-name {
            font-size: 20px;
            font-weight: bold;
        }

        .submit-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 18px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: all 0.3s;
        }

        .submit-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .submit-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 14px;
        }

        /* Main App Styles */
        .header {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .header h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .child-name-header {
            color: #764ba2;
            font-size: 20px;
            margin-bottom: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .voice-section {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .voice-title {
            font-size: 20px;
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .voice-message {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .voice-message:hover {
            background: #eef0ff;
            transform: translateY(-2px);
        }

        .voice-message.playing {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .voice-date {
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
        }

        .voice-message.playing .voice-date {
            color: rgba(255,255,255,0.8);
        }

        .voice-text {
            font-size: 16px;
            color: #333;
        }

        .voice-message.playing .voice-text {
            color: white;
        }

        .no-message {
            text-align: center;
            color: #999;
            padding: 40px 20px;
        }

        .academies-section {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .academies-title {
            font-size: 20px;
            color: #667eea;
            margin-bottom: 15px;
        }

        .academy-card {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .academy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .academy-name {
            font-size: 18px;
            color: #333;
            font-weight: bold;
        }

        .academy-status {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .days-info {
            font-size: 12px;
            color: #666;
            background: white;
            padding: 5px 10px;
            border-radius: 20px;
        }

        .check-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }

        .check-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .check-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .progress-bar {
            background: #e0e0e0;
            height: 8px;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            background: linear-gradient(90deg, #667eea, #764ba2);
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s;
        }

        .attendance-rate {
            text-align: center;
            margin-top: 5px;
            font-size: 14px;
            color: #667eea;
            font-weight: bold;
        }

        .badges-section {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .badges-title {
            font-size: 20px;
            color: #667eea;
            margin-bottom: 15px;
        }

        .badges-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .badge {
            text-align: center;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 15px;
            opacity: 0.3;
            transition: all 0.3s;
        }

        .badge.earned {
            opacity: 1;
            background: linear-gradient(135deg, #fff5e6, #ffe0b3);
        }

        .badge-icon {
            font-size: 40px;
            margin-bottom: 5px;
        }

        .badge-name {
            font-size: 12px;
            color: #333;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 18px;
        }

        .celebration {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            z-index: 1000;
            display: none;
        }

        .celebration.show {
            display: block;
            animation: popIn 0.5s;
        }

        @keyframes popIn {
            0% { transform: translate(-50%, -50%) scale(0); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        .celebration-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .celebration-text {
            font-size: 24px;
            color: #667eea;
            margin-bottom: 10px;
        }

        .celebration-subtext {
            font-size: 16px;
            color: #666;
            margin-bottom: 20px;
        }

        .points-earned {
            font-size: 32px;
            color: #764ba2;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .close-celebration {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
        }

        .logout-button {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 15px;
        }

        .pwa-install-prompt {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }

        .pwa-install-prompt h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .pwa-install-prompt p {
            color: #666;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .pwa-install-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
        }

        .close-prompt {
            background: transparent;
            color: #999;
            border: none;
            padding: 10px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading" class="loading">
            <div>ë¡œë”© ì¤‘...</div>
        </div>

        <!-- Onboarding Screen -->
        <div id="onboarding" style="display: none;">
            <div class="onboarding">
                <div class="onboarding-title">ğŸ’ í•™ì›ê°€ì!</div>
                <div class="onboarding-subtitle">í™˜ì˜í•©ë‹ˆë‹¤!</div>

                <div id="familyCodeSection" class="family-code-section">
                    <div class="family-code-label">ê°€ì¡± ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>
                    <input type="text" 
                           id="familyCodeInput" 
                           class="family-code-input" 
                           placeholder="ì˜ˆ: ABC123"
                           maxlength="8">
                    <div class="family-code-help">
                        ë¶€ëª¨ë‹˜ ì•±ì—ì„œ ê°€ì¡± ì½”ë“œë¥¼ í™•ì¸í•˜ì„¸ìš”
                    </div>
                    <button class="submit-button" onclick="searchFamily()">ë‹¤ìŒ</button>
                </div>

                <div id="childrenSection" style="display: none;">
                    <div class="onboarding-subtitle">ëˆ„êµ¬ì„¸ìš”?</div>
                    <div class="children-list" id="childrenList"></div>
                    <button class="submit-button" id="selectChildButton" onclick="selectChild()" disabled>
                        ì‹œì‘í•˜ê¸°
                    </button>
                </div>

                <div id="errorMessage" class="error-message" style="display: none;"></div>
            </div>
        </div>

        <!-- PWA Install Prompt -->
        <div id="pwaPrompt" class="pwa-install-prompt" style="display: none;">
            <h3>ğŸ“± í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ê¸°</h3>
            <p>í•™ì›ê°€ìë¥¼ í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ë©´<br>ì•±ì²˜ëŸ¼ í¸í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ìš”!</p>
            <button class="pwa-install-button" onclick="showInstallInstructions()">
                ì„¤ì¹˜ ë°©ë²• ë³´ê¸°
            </button>
            <button class="close-prompt" onclick="closePWAPrompt()">
                ë‚˜ì¤‘ì—
            </button>
        </div>

        <!-- Main App -->
        <div id="app" style="display: none;">
            <!-- Header -->
            <div class="header">
                <h1>ğŸ’ í•™ì›ê°€ì!</h1>
                <div class="child-name-header" id="childName">ì–´ë¦°ì´</div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalPoints">0</div>
                        <div class="stat-label">í¬ì¸íŠ¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalBadges">0</div>
                        <div class="stat-label">ë°°ì§€</div>
                    </div>
                </div>

                <button class="logout-button" onclick="logout()">ë‹¤ë¥¸ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸</button>
            </div>

            <!-- Voice Messages -->
            <div class="voice-section">
                <div class="voice-title">
                    ğŸ¤ ë¶€ëª¨ë‹˜ ë©”ì‹œì§€
                </div>
                <div id="voiceMessages">
                    <div class="no-message">ì•„ì§ ë©”ì‹œì§€ê°€ ì—†ì–´ìš”</div>
                </div>
            </div>

            <!-- Academies -->
            <div class="academies-section">
                <div class="academies-title">ğŸ“š ì˜¤ëŠ˜ì˜ í•™ì›</div>
                <div id="academiesList"></div>
            </div>

            <!-- Badges -->
            <div class="badges-section">
                <div class="badges-title">ğŸ† ë‚˜ì˜ ë°°ì§€</div>
                <div class="badges-grid" id="badgesGrid"></div>
            </div>
        </div>

        <!-- Celebration Modal -->
        <div id="celebration" class="celebration">
            <div class="celebration-icon">ğŸ‰</div>
            <div class="celebration-text">ì¶œì„ ì™„ë£Œ!</div>
            <div class="celebration-subtext" id="celebrationMessage"></div>
            <div class="points-earned">+<span id="pointsEarned">10</span> í¬ì¸íŠ¸</div>
            <button class="close-celebration" onclick="closeCelebration()">í™•ì¸</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, query, where, getDocs, doc, getDoc, updateDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCqsQ3GPkspxBiO-5qQnc8MhliCNZZ7sks",
            authDomain: "hakwongaja.firebaseapp.com",
            projectId: "hakwongaja",
            storageBucket: "hakwongaja.firebasestorage.app",
            messagingSenderId: "789429857818",
            appId: "1:789429857818:web:f526c57530a59f8395aba3",
            measurementId: "G-JG7S5Z6FG8"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Global variables
        let currentChildId = null;
        let currentParentId = null;
        let currentAudio = null;
        let selectedChildId = null;

        // Badge definitions
        const BADGES = [
            { id: 'first', name: 'ì²« ì¶œì„', icon: 'ğŸŒŸ', condition: (data) => data.totalDays >= 1 },
            { id: 'week', name: 'ì¼ì£¼ì¼', icon: 'ğŸ“…', condition: (data) => data.totalDays >= 7 },
            { id: 'month', name: 'í•œ ë‹¬', icon: 'ğŸ¯', condition: (data) => data.totalDays >= 30 },
            { id: 'perfect50', name: '50% ë‹¬ì„±', icon: 'â­', condition: (data) => getAttendanceRate(data) >= 50 },
            { id: 'perfect70', name: '70% ë‹¬ì„±', icon: 'ğŸŒŸ', condition: (data) => getAttendanceRate(data) >= 70 },
            { id: 'perfect90', name: '90% ë‹¬ì„±', icon: 'ğŸ’«', condition: (data) => getAttendanceRate(data) >= 90 },
            { id: 'hundred', name: '100ì¼', icon: 'ğŸ†', condition: (data) => data.totalDays >= 100 },
            { id: 'points100', name: 'í¬ì¸íŠ¸ ì™•', icon: 'ğŸ’', condition: (data) => data.totalPoints >= 100 },
            { id: 'streak7', name: 'ì—°ì† 7ì¼', icon: 'ğŸ”¥', condition: (data) => data.currentStreak >= 7 }
        ];

        // Helper Functions
        function getDayName(dayIndex) {
            const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            return days[dayIndex];
        }

        function getTodayString() {
            return new Date().toISOString().split('T')[0];
        }

        function getAttendanceRate(childData) {
            if (!childData.academies) return 0;
            
            const today = new Date();
            const totalDays = Object.values(childData.academies).reduce((sum, academy) => {
                return sum + academy.days.length * 4;
            }, 0);
            
            if (totalDays === 0) return 100;
            
            const totalAttended = childData.totalDays || 0;
            return Math.min(100, Math.round((totalAttended / totalDays) * 100));
        }

        // Check and award badges
        function checkBadges(childData) {
            const earnedBadges = [];
            BADGES.forEach(badge => {
                if (badge.condition(childData) && !childData.badges?.includes(badge.id)) {
                    earnedBadges.push(badge.id);
                }
            });
            return earnedBadges;
        }

        // Search for family by code
        window.searchFamily = async function() {
            const familyCode = document.getElementById('familyCodeInput').value.trim().toUpperCase();
            const errorDiv = document.getElementById('errorMessage');
            
            if (!familyCode) {
                errorDiv.textContent = 'ê°€ì¡± ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”';
                errorDiv.style.display = 'block';
                return;
            }

            errorDiv.style.display = 'none';

            try {
                // Search for parent with this family code
                const parentsRef = collection(db, 'parents');
                const q = query(parentsRef, where('familyCode', '==', familyCode));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    errorDiv.textContent = 'ê°€ì¡± ì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
                    errorDiv.style.display = 'block';
                    return;
                }

                // Get parent data
                const parentDoc = querySnapshot.docs[0];
                currentParentId = parentDoc.id;
                const parentData = parentDoc.data();

                if (!parentData.children || parentData.children.length === 0) {
                    errorDiv.textContent = 'ë“±ë¡ëœ ìë…€ê°€ ì—†ìŠµë‹ˆë‹¤';
                    errorDiv.style.display = 'block';
                    return;
                }

                // Show children list
                displayChildrenList(parentData.children);

            } catch (error) {
                console.error('Error searching family:', error);
                errorDiv.textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                errorDiv.style.display = 'block';
            }
        };

        // Display children list
        function displayChildrenList(children) {
            const childrenList = document.getElementById('childrenList');
            childrenList.innerHTML = '';

            children.forEach(child => {
                const childDiv = document.createElement('div');
                childDiv.className = 'child-option';
                childDiv.dataset.childId = child.id;
                childDiv.innerHTML = `<div class="child-name">${child.name}</div>`;
                
                childDiv.onclick = function() {
                    document.querySelectorAll('.child-option').forEach(el => 
                        el.classList.remove('selected')
                    );
                    this.classList.add('selected');
                    selectedChildId = this.dataset.childId;
                    document.getElementById('selectChildButton').disabled = false;
                };

                childrenList.appendChild(childDiv);
            });

            document.getElementById('familyCodeSection').style.display = 'none';
            document.getElementById('childrenSection').style.display = 'block';
        }

        // Select child and save to localStorage
        window.selectChild = function() {
            if (!selectedChildId || !currentParentId) return;

            // Save to localStorage
            localStorage.setItem('childId', selectedChildId);
            localStorage.setItem('parentId', currentParentId);

            // Load main app
            currentChildId = selectedChildId;
            loadMainApp();
        };

        // Logout function
        window.logout = function() {
            if (confirm('ë‹¤ë¥¸ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('childId');
                localStorage.removeItem('parentId');
                localStorage.removeItem('pwaPromptClosed');
                location.reload();
            }
        };

        // Load main app
        function loadMainApp() {
            document.getElementById('onboarding').style.display = 'none';
            document.getElementById('loading').style.display = 'none';
            document.getElementById('app').style.display = 'block';

            // Show PWA install prompt if not closed before
            if (!localStorage.getItem('pwaPromptClosed') && !window.matchMedia('(display-mode: standalone)').matches) {
                setTimeout(() => {
                    document.getElementById('pwaPrompt').style.display = 'block';
                }, 2000);
            }

            // Listen to child data
            const childDocRef = doc(db, 'children', currentChildId);
            onSnapshot(childDocRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const childData = docSnapshot.data();
                    updateUI(childData);
                } else {
                    alert('ìë…€ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    logout();
                }
            });
        }

        // Render voice messages
        async function renderVoiceMessages(childData) {
            const container = document.getElementById('voiceMessages');
            
            if (!childData.voiceMessages || childData.voiceMessages.length === 0) {
                container.innerHTML = '<div class="no-message">ì•„ì§ ë©”ì‹œì§€ê°€ ì—†ì–´ìš”</div>';
                return;
            }

            container.innerHTML = '';
            
            const sortedMessages = [...childData.voiceMessages].sort((a, b) => 
                new Date(b.createdAt) - new Date(a.createdAt)
            );

            for (const message of sortedMessages) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'voice-message';
                messageDiv.dataset.url = message.url;
                
                const date = new Date(message.createdAt);
                const dateStr = `${date.getMonth() + 1}ì›” ${date.getDate()}ì¼`;
                
                messageDiv.innerHTML = `
                    <div class="voice-date">${dateStr}</div>
                    <div class="voice-text">ğŸ¤ ë¶€ëª¨ë‹˜ì˜ ìŒì„± ë©”ì‹œì§€ (í´ë¦­í•´ì„œ ë“£ê¸°)</div>
                `;
                
                messageDiv.onclick = () => playVoiceMessage(message.url, messageDiv);
                container.appendChild(messageDiv);
            }
        }

        // Play voice message
        async function playVoiceMessage(url, element) {
            if (currentAudio) {
                currentAudio.pause();
                document.querySelectorAll('.voice-message').forEach(el => 
                    el.classList.remove('playing')
                );
            }

            try {
                const audioRef = ref(storage, url);
                const downloadURL = await getDownloadURL(audioRef);
                
                currentAudio = new Audio(downloadURL);
                element.classList.add('playing');
                
                currentAudio.onended = () => {
                    element.classList.remove('playing');
                    currentAudio = null;
                };
                
                currentAudio.onerror = () => {
                    element.classList.remove('playing');
                    alert('ìŒì„± ë©”ì‹œì§€ë¥¼ ì¬ìƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    currentAudio = null;
                };
                
                await currentAudio.play();
            } catch (error) {
                console.error('Error playing audio:', error);
                element.classList.remove('playing');
                alert('ìŒì„± ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        }

        // Render academies
        function renderAcademies(childData) {
            const container = document.getElementById('academiesList');
            
            if (!childData.academies || Object.keys(childData.academies).length === 0) {
                container.innerHTML = '<div class="no-message">ë“±ë¡ëœ í•™ì›ì´ ì—†ì–´ìš”</div>';
                return;
            }

            const today = new Date().getDay();
            const todayStr = getTodayString();
            
            container.innerHTML = '';
            
            Object.entries(childData.academies).forEach(([academyId, academy]) => {
                const isTodayClass = academy.days.includes(today);
                
                if (!isTodayClass) return;

                const todayAttended = childData.attendance?.[todayStr]?.[academyId] || false;
                const rate = getAttendanceRate(childData);
                
                const academyDiv = document.createElement('div');
                academyDiv.className = 'academy-card';
                academyDiv.innerHTML = `
                    <div class="academy-header">
                        <div class="academy-name">${academy.name}</div>
                        <div class="academy-status">
                            <div class="days-info">${academy.days.map(d => getDayName(d)).join(', ')}</div>
                        </div>
                    </div>
                    <button class="check-button" 
                        onclick="checkAttendance('${academyId}')"
                        ${todayAttended ? 'disabled' : ''}>
                        ${todayAttended ? 'âœ“ ì¶œì„ ì™„ë£Œ' : 'ì¶œì„ ì²´í¬í•˜ê¸°'}
                    </button>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${rate}%"></div>
                    </div>
                    <div class="attendance-rate">${rate}% ë‹¬ì„±</div>
                `;
                
                container.appendChild(academyDiv);
            });

            if (container.children.length === 0) {
                container.innerHTML = '<div class="no-message">ì˜¤ëŠ˜ì€ í•™ì›ì´ ì—†ì–´ìš”</div>';
            }
        }

        // Render badges
        function renderBadges(childData) {
            const container = document.getElementById('badgesGrid');
            container.innerHTML = '';
            
            BADGES.forEach(badge => {
                const isEarned = childData.badges?.includes(badge.id) || false;
                const badgeDiv = document.createElement('div');
                badgeDiv.className = `badge ${isEarned ? 'earned' : ''}`;
                badgeDiv.innerHTML = `
                    <div class="badge-icon">${badge.icon}</div>
                    <div class="badge-name">${badge.name}</div>
                `;
                container.appendChild(badgeDiv);
            });
        }

        // Update UI
        function updateUI(childData) {
            document.getElementById('childName').textContent = childData.name || 'ì–´ë¦°ì´';
            document.getElementById('totalPoints').textContent = childData.totalPoints || 0;
            document.getElementById('totalBadges').textContent = childData.badges?.length || 0;
            
            renderVoiceMessages(childData);
            renderAcademies(childData);
            renderBadges(childData);
        }

        // Check attendance
        window.checkAttendance = async function(academyId) {
            if (!currentChildId) return;
            
            const todayStr = getTodayString();
            const childDocRef = doc(db, 'children', currentChildId);
            
            try {
                const childDoc = await getDoc(childDocRef);
                const childData = childDoc.data();
                
                const attendance = childData.attendance || {};
                if (!attendance[todayStr]) {
                    attendance[todayStr] = {};
                }
                attendance[todayStr][academyId] = true;
                
                const pointsToAdd = 10;
                const totalPoints = (childData.totalPoints || 0) + pointsToAdd;
                const totalDays = (childData.totalDays || 0) + 1;
                
                const updatedData = {
                    ...childData,
                    attendance,
                    totalPoints,
                    totalDays
                };
                
                const newBadges = checkBadges(updatedData);
                const badges = [...(childData.badges || []), ...newBadges];
                
                await updateDoc(childDocRef, {
                    attendance,
                    totalPoints,
                    totalDays,
                    badges
                });
                
                showCelebration(pointsToAdd, newBadges);
                
            } catch (error) {
                console.error('Error checking attendance:', error);
                alert('ì¶œì„ ì²´í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        };

        // Show celebration
        function showCelebration(points, newBadges) {
            const celebration = document.getElementById('celebration');
            const message = document.getElementById('celebrationMessage');
            document.getElementById('pointsEarned').textContent = points;
            
            if (newBadges.length > 0) {
                const badgeNames = newBadges.map(id => 
                    BADGES.find(b => b.id === id)?.name
                ).join(', ');
                message.textContent = `ìƒˆ ë°°ì§€ íšë“: ${badgeNames}`;
            } else {
                message.textContent = 'ì˜í–ˆì–´ìš”!';
            }
            
            celebration.classList.add('show');
        }

        window.closeCelebration = function() {
            document.getElementById('celebration').classList.remove('show');
        };

        // PWA functions
        window.showInstallInstructions = function() {
            const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/.test(navigator.userAgent);
            
            let instructions = '';
            
            if (isIOS) {
                instructions = `ğŸ“± iOS ì„¤ì¹˜ ë°©ë²•:\n\n1. í™”ë©´ í•˜ë‹¨ì˜ ê³µìœ  ë²„íŠ¼ (â–¡â†‘) í´ë¦­\n2. "í™ˆ í™”ë©´ì— ì¶”ê°€" ì„ íƒ\n3. "ì¶”ê°€" ë²„íŠ¼ í´ë¦­\n4. í™ˆ í™”ë©´ì— ì•„ì´ì½˜ ìƒì„± ì™„ë£Œ!`;
            } else if (isAndroid) {
                instructions = `ğŸ“± Android ì„¤ì¹˜ ë°©ë²•:\n\n1. í™”ë©´ ìš°ì¸¡ ìƒë‹¨ ë©”ë‰´ (â‹®) í´ë¦­\n2. "í™ˆ í™”ë©´ì— ì¶”ê°€" ì„ íƒ\n3. "ì„¤ì¹˜" ë˜ëŠ” "ì¶”ê°€" ë²„íŠ¼ í´ë¦­\n4. í™ˆ í™”ë©´ì— ì•„ì´ì½˜ ìƒì„± ì™„ë£Œ!`;
            } else {
                instructions = `ğŸ“± ì„¤ì¹˜ ë°©ë²•:\n\në¸Œë¼ìš°ì € ë©”ë‰´ì—ì„œ\n"í™ˆ í™”ë©´ì— ì¶”ê°€" ë˜ëŠ”\n"ë°”ë¡œê°€ê¸° ì¶”ê°€"ë¥¼ ì„ íƒí•˜ì„¸ìš”`;
            }
            
            alert(instructions);
            closePWAPrompt();
        };

        window.closePWAPrompt = function() {
            document.getElementById('pwaPrompt').style.display = 'none';
            localStorage.setItem('pwaPromptClosed', 'true');
        };

        // Initialize app
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Check localStorage for saved login
                const savedChildId = localStorage.getItem('childId');
                const savedParentId = localStorage.getItem('parentId');

                if (savedChildId && savedParentId) {
                    // Auto login
                    currentChildId = savedChildId;
                    currentParentId = savedParentId;
                    loadMainApp();
                } else {
                    // Show onboarding
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('onboarding').style.display = 'block';
                }
            } else {
                // Sign in anonymously
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error('Error signing in:', error);
                    alert('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }
        });
    </script>
</body>
</html>
