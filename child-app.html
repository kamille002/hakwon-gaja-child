<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™ì›ê°€ì í”„ë¦¬ë¯¸ì—„ - ìë…€ì•± (Firebase)</title>
    
    <style>
        @import url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2001@1.1/GmarketSansMedium.woff') format('woff');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'GmarketSansMedium', -apple-system, sans-serif;
            background: linear-gradient(135deg, #E8DFF5 0%, #FCE1E4 100%);
            min-height: 100vh;
            color: #2D3748;
        }
        
        .app-container {
            max-width: 480px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #9C6FDE 0%, #B794F6 100%);
            padding: 25px 20px;
            color: white;
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .app-title {
            font-size: 28px;
            font-weight: bold;
        }
        
        .firebase-badge {
            background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
            padding: 5px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            color: white;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .greeting {
            font-size: 18px;
        }
        
        .main-content {
            padding: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #9C6FDE;
        }
        
        /* Login */
        .login-section {
            text-align: center;
            padding: 40px 20px;
        }
        
        .login-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }
        
        .login-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .login-subtitle {
            font-size: 14px;
            color: #718096;
            margin-bottom: 30px;
        }
        
        .invite-code-input {
            width: 100%;
            max-width: 300px;
            padding: 15px;
            border: 2px solid #E2E8F0;
            border-radius: 12px;
            font-size: 24px;
            text-align: center;
            letter-spacing: 4px;
            margin-bottom: 20px;
            text-transform: uppercase;
            font-family: monospace;
        }
        
        .login-btn {
            width: 100%;
            max-width: 300px;
            background: linear-gradient(135deg, #9C6FDE 0%, #B794F6 100%);
            border: none;
            color: white;
            padding: 15px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* Points */
        .points-section {
            background: linear-gradient(135deg, #FFD93D 0%, #FFAA4C 100%);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            color: white;
        }
        
        .points-display {
            font-size: 48px;
            font-weight: bold;
        }
        
        .points-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* Attendance */
        .attendance-section {
            background: white;
            border: 2px solid #E2E8F0;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .attendance-title {
            text-align: center;
            font-size: 14px;
            color: #718096;
            margin-bottom: 10px;
        }
        
        .attendance-rate {
            font-size: 56px;
            font-weight: bold;
            color: #9C6FDE;
            text-align: center;
        }
        
        .progress-bar-container {
            background: #E2E8F0;
            height: 24px;
            border-radius: 12px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #9C6FDE 0%, #B794F6 100%);
            transition: width 0.5s ease;
        }
        
        .encouragement-box {
            background: linear-gradient(135deg, #E9D8FD 0%, #F3E8FF 100%);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }
        
        .encouragement-emoji {
            font-size: 40px;
            margin-bottom: 10px;
        }
        
        .encouragement-text {
            font-size: 16px;
            color: #6B46C1;
            font-weight: bold;
        }
        
        /* Rewards */
        .rewards-section {
            background: white;
            border: 2px solid #E2E8F0;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .reward-card {
            background: #F7FAFC;
            border: 2px solid #E2E8F0;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .reward-card.can-claim {
            background: linear-gradient(135deg, #C6F6D5 0%, #9AE6B4 100%);
            border-color: #48BB78;
        }
        
        .reward-name {
            font-size: 16px;
            font-weight: bold;
        }
        
        .reward-points {
            font-size: 14px;
            color: #F59E0B;
            margin-top: 5px;
        }
        
        .claim-btn {
            background: #48BB78;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .claim-btn:disabled {
            background: #E2E8F0;
            color: #A0AEC0;
            cursor: not-allowed;
        }
        
        /* Today's Academies */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .checkin-btn {
            background: linear-gradient(135deg, #48BB78 0%, #38A169 100%);
            border: none;
            color: white;
            padding: 12px 20px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .arrived-btn {
            background: linear-gradient(135deg, #4299E1 0%, #3182CE 100%);
        }
        
        .academy-card {
            background: white;
            border: 2px solid #E2E8F0;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .academy-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .academy-info {
            color: #4A5568;
            font-size: 14px;
            margin: 5px 0;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #A0AEC0;
        }
        
        .empty-icon {
            font-size: 64px;
            margin-bottom: 15px;
        }
        
        .empty-text {
            font-size: 16px;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <div class="header-top">
                <div class="app-title">ğŸ’ í•™ì›ê°€ì</div>
                <div class="firebase-badge">
                    <span>ğŸ”¥</span>
                    <span>LIVE</span>
                </div>
            </div>
            <div class="greeting" id="greeting">í™˜ì˜í•©ë‹ˆë‹¤!</div>
        </div>
        
        <!-- Loading -->
        <div id="loadingSection" class="loading">
            Firebase ì—°ê²° ì¤‘...
        </div>
        
        <!-- Login -->
        <div id="loginSection" class="main-content hidden">
            <div class="login-section">
                <div class="login-icon">ğŸ”</div>
                <div class="login-title">ì´ˆëŒ€ ì½”ë“œ ì…ë ¥</div>
                <div class="login-subtitle">ë¶€ëª¨ë‹˜ì´ ì•Œë ¤ì¤€ 6ìë¦¬ ì½”ë“œ</div>
                <input type="text" class="invite-code-input" id="inviteCodeInput" placeholder="------" maxlength="6" />
                <br/><br/>
                <button class="login-btn" onclick="login()">ì…ì¥í•˜ê¸°</button>
            </div>
        </div>
        
        <!-- Main -->
        <div id="mainSection" class="main-content hidden">
            <div class="points-section">
                <div class="points-display" id="pointsDisplay">0P</div>
                <div class="points-label">ë‚´ í¬ì¸íŠ¸</div>
            </div>
            
            <div class="attendance-section">
                <div class="attendance-title">ì´ë²ˆ ë‹¬ ì¶œì„ë¥ </div>
                <div class="attendance-rate" id="attendanceRate">0%</div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                </div>
                <div class="encouragement-box">
                    <div class="encouragement-emoji" id="encouragementEmoji">ğŸ˜Š</div>
                    <div class="encouragement-text" id="encouragementText">ì´ì œ ì‹œì‘ì´ì•¼!</div>
                </div>
            </div>
            
            <div class="rewards-section">
                <div class="section-title">ğŸ ë³´ìƒ ëª©ë¡</div>
                <div id="rewardsList"></div>
            </div>
            
            <div class="section">
                <div class="section-header">
                    <div class="section-title">ì˜¤ëŠ˜ì˜ í•™ì›</div>
                    <div class="action-buttons">
                        <button class="checkin-btn" onclick="checkIn()">ì¶œë°œ! ğŸƒ</button>
                        <button class="checkin-btn arrived-btn" onclick="markArrived()">ë„ì°©! ğŸ“</button>
                    </div>
                </div>
                <div id="todayAcademyList"></div>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <script>
        // ==========================================
        // Firebase ì„¤ì •
        // ==========================================
        
        // TODO: Firebase Consoleì—ì„œ ë³µì‚¬í•œ ì„¤ì •ìœ¼ë¡œ êµì²´í•˜ì„¸ìš”!
        const firebaseConfig = {
            apiKey: "AIzaSyCqsQ3GPkspxBiO-5qQnc8MhliCNZZ7sks",
            authDomain: "hakwongaja.firebaseapp.com",
            projectId: "hakwongaja",
            storageBucket: "hakwongaja.firebasestorage.app",
            messagingSenderId: "789429857818",
            appId: "1:789429857818:web:f526c57530a59f8395aba3",
            measurementId: "G-JG7S5Z6FG8"
        };
        
        // Firebase ì´ˆê¸°í™”
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        
        // ==========================================
        // ìœ í‹¸ë¦¬í‹°
        // ==========================================
        
        const DateUtils = {
            getTodayKorean() {
                const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
                return days[new Date().getDay()];
            },
            getDateString(date = new Date()) {
                return date.toISOString().split('T')[0];
            },
            getMonthStart(date = new Date()) {
                return new Date(date.getFullYear(), date.getMonth(), 1);
            },
            getMonthEnd(date = new Date()) {
                return new Date(date.getFullYear(), date.getMonth() + 1, 0);
            },
            getCurrentTime() {
                const now = new Date();
                return \`\${now.getHours().toString().padStart(2, '0')}:\${now.getMinutes().toString().padStart(2, '0')}\`;
            }
        };
        
        const AttendanceUtils = {
            calculateMonthlyGoal(academies) {
                let totalDays = 0;
                for (let academyId in academies) {
                    const academy = academies[academyId];
                    totalDays += academy.days.length * 4;
                }
                return Math.max(totalDays, 1);
            },
            countAttendance(attendance) {
                if (!attendance) return 0;
                const monthStart = DateUtils.getDateString(DateUtils.getMonthStart());
                const monthEnd = DateUtils.getDateString(DateUtils.getMonthEnd());
                let count = 0;
                for (let date in attendance) {
                    if (date >= monthStart && date <= monthEnd) {
                        count += attendance[date].length;
                    }
                }
                return count;
            },
            calculateRate(academies, attendance) {
                const goal = this.calculateMonthlyGoal(academies);
                const attended = this.countAttendance(attendance);
                return {
                    rate: Math.min(Math.round((attended / goal) * 100), 100),
                    attended: attended,
                    goal: goal,
                    remaining: Math.max(goal - attended, 0)
                };
            },
            getMilestone(rate) {
                if (rate >= 100) return { level: 4, badge: 'ğŸ’', name: 'ì™„ë²½!', bonus: 100 };
                if (rate >= 90) return { level: 3, badge: 'ğŸ¥‡', name: 'ê±°ì˜ ì™„ë²½!', bonus: 50 };
                if (rate >= 70) return { level: 2, badge: 'ğŸ¥ˆ', name: 'ê¾¸ì¤€í•¨!', bonus: 30 };
                if (rate >= 50) return { level: 1, badge: 'ğŸ¥‰', name: 'ì²« ê±¸ìŒ!', bonus: 10 };
                return { level: 0, badge: 'ğŸŒ±', name: 'ì‹œì‘!', bonus: 0 };
            },
            getEncouragementMessage(rate) {
                if (rate >= 100) return 'ğŸ’ ì™„ë²½í•´! ë„ˆ ì •ë§ ìµœê³ ì•¼! ğŸŠ';
                if (rate >= 90) return 'ğŸ¥‡ ëŒ€ë°•! 90%ì•¼! ëê¹Œì§€ ê°€ì! â­';
                if (rate >= 70) return 'ğŸ¥ˆ ê±°ì˜ ë‹¤ ì™”ì–´! ì¡°ê¸ˆë§Œ ë”! ğŸ”¥';
                if (rate >= 50) return 'ğŸ¥‰ ì ˆë°˜ ë„˜ì—ˆë‹¤! ëŒ€ë‹¨í•´! ğŸ‰';
                if (rate >= 30) return 'ì˜í•˜ê³  ìˆì–´! ê³„ì† ê°€ë³´ì! ğŸ’ª';
                return 'ì´ì œ ì‹œì‘ì´ì•¼! ì²œì²œíˆ ê°€ì ğŸ˜Š';
            }
        };
        
        const AlarmUtils = {
            getTodayAcademies(academies) {
                const today = DateUtils.getTodayKorean();
                const result = [];
                for (let id in academies) {
                    const academy = academies[id];
                    if (academy.days.includes(today)) {
                        result.push({ id, ...academy });
                    }
                }
                result.sort((a, b) => a.departureTime.localeCompare(b.departureTime));
                return result;
            },
            checkAlarms(academies, voiceRecordingURL, onAlarm) {
                const currentTime = DateUtils.getCurrentTime();
                const todayAcademies = this.getTodayAcademies(academies);
                
                todayAcademies.forEach(academy => {
                    if (academy.departureTime === currentTime) {
                        const alarmKey = \`alarm_\${academy.id}_\${DateUtils.getDateString()}\`;
                        if (!sessionStorage.getItem(alarmKey)) {
                            sessionStorage.setItem(alarmKey, 'true');
                            if (voiceRecordingURL) {
                                const audio = new Audio(voiceRecordingURL);
                                audio.play();
                            }
                            onAlarm(academy);
                        }
                    }
                });
            }
        };
        
        // ==========================================
        // ì•± ë°ì´í„°
        // ==========================================
        
        let childData = null;
        let childId = null;
        let alarmInterval = null;
        let unsubscribeChild = null;
        
        // ==========================================
        // Firebase ì´ˆê¸°í™”
        // ==========================================
        
        async function init() {
            try {
                // ì €ì¥ëœ childId í™•ì¸
                const savedChildId = localStorage.getItem('childId_firebase');
                
                if (savedChildId) {
                    // ì´ë¯¸ ë¡œê·¸ì¸í•œ ì  ìˆìŒ
                    childId = savedChildId;
                    await loadChildData();
                } else {
                    // ë¡œê·¸ì¸ í•„ìš”
                    showLogin();
                }
                
            } catch (error) {
                console.error('Init error:', error);
                document.getElementById('loadingSection').innerHTML = 
                    'Firebase ì—°ê²° ì‹¤íŒ¨!<br/><small>firebaseConfigë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.</small>';
            }
        }
        
        function showLogin() {
            document.getElementById('loadingSection').classList.add('hidden');
            document.getElementById('loginSection').classList.remove('hidden');
        }
        
        function showMainApp() {
            document.getElementById('loadingSection').classList.add('hidden');
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('mainSection').classList.remove('hidden');
        }
        
        async function loadChildData() {
            try {
                // Firestoreì—ì„œ ìë…€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const childDoc = await db.collection('children').doc(childId).get();
                
                if (!childDoc.exists) {
                    alert('ìœ íš¨í•˜ì§€ ì•Šì€ ì´ˆëŒ€ ì½”ë“œì…ë‹ˆë‹¤!');
                    localStorage.removeItem('childId_firebase');
                    showLogin();
                    return;
                }
                
                childData = { id: childDoc.id, ...childDoc.data() };
                
                // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ êµ¬ë…
                subscribeToUpdates();
                
                showMainApp();
                render();
                
                // ì•ŒëŒ ì²´í¬ ì‹œì‘
                startAlarmCheck();
                
            } catch (error) {
                console.error('Load child data error:', error);
                alert('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨!');
            }
        }
        
        function subscribeToUpdates() {
            // ìë…€ ë°ì´í„° ì‹¤ì‹œê°„ êµ¬ë…
            unsubscribeChild = db.collection('children').doc(childId)
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        childData = { id: doc.id, ...doc.data() };
                        render();
                    }
                });
        }
        
        async function login() {
            const inviteCode = document.getElementById('inviteCodeInput').value.trim().toUpperCase();
            
            if (inviteCode.length !== 6) {
                alert('6ìë¦¬ ì´ˆëŒ€ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }
            
            try {
                // Firestoreì—ì„œ ì´ˆëŒ€ ì½”ë“œë¡œ ìë…€ ì°¾ê¸°
                const snapshot = await db.collection('children')
                    .where('inviteCode', '==', inviteCode)
                    .limit(1)
                    .get();
                
                if (snapshot.empty) {
                    alert('ìœ íš¨í•˜ì§€ ì•Šì€ ì´ˆëŒ€ ì½”ë“œì…ë‹ˆë‹¤!');
                    return;
                }
                
                const doc = snapshot.docs[0];
                childId = doc.id;
                childData = { id: doc.id, ...doc.data() };
                
                // childId ì €ì¥
                localStorage.setItem('childId_firebase', childId);
                
                // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ êµ¬ë…
                subscribeToUpdates();
                
                showMainApp();
                render();
                
                // ì•ŒëŒ ì²´í¬ ì‹œì‘
                startAlarmCheck();
                
                alert(\`í™˜ì˜í•©ë‹ˆë‹¤, \${childData.name}! ğŸ‰\`);
                
            } catch (error) {
                console.error('Login error:', error);
                alert('ë¡œê·¸ì¸ ì‹¤íŒ¨! ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }
        
        // ==========================================
        // ì•ŒëŒ
        // ==========================================
        
        function startAlarmCheck() {
            if (alarmInterval) clearInterval(alarmInterval);
            alarmInterval = setInterval(() => {
                checkAlarms();
            }, 60000); // 1ë¶„ë§ˆë‹¤
            checkAlarms();
        }
        
        function checkAlarms() {
            if (!childData) return;
            
            AlarmUtils.checkAlarms(
                childData.academies || {}, 
                childData.voiceRecordingURL,
                (academy) => {
                    alert(\`ğŸ”” ì•ŒëŒ!\n\n\${academy.name} ì¶œë°œ ì‹œê°„ì´ì—ìš”!\nìˆ˜ì—… ì‹œì‘: \${academy.classTime}\`);
                }
            );
        }
        
        // ==========================================
        // ì¶œì„ ì²´í¬
        // ==========================================
        
        async function checkIn() {
            if (!childData) return;
            
            const todayAcademies = AlarmUtils.getTodayAcademies(childData.academies || {});
            
            if (todayAcademies.length === 0) {
                alert('ì˜¤ëŠ˜ì€ í•™ì›ì´ ì—†ì–´ìš”!');
                return;
            }
            
            try {
                const today = DateUtils.getDateString();
                const attendance = childData.attendance || {};
                
                if (!attendance[today]) {
                    attendance[today] = [];
                }
                
                todayAcademies.forEach(academy => {
                    if (!attendance[today].includes(academy.id)) {
                        attendance[today].push(academy.id);
                    }
                });
                
                // Firestore ì—…ë°ì´íŠ¸
                await db.collection('children').doc(childId).update({
                    attendance: attendance,
                    points: (childData.points || 0) + 10
                });
                
                alert('âœ… ì¶œë°œ í™•ì¸! +10P');
                
            } catch (error) {
                console.error('Check-in error:', error);
                alert('ì¶œì„ ì²´í¬ ì‹¤íŒ¨! ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }
        
        async function markArrived() {
            if (!childData) return;
            
            try {
                const today = DateUtils.getDateString();
                const arrivals = childData.arrivals || {};
                arrivals[today] = Date.now();
                
                // Firestore ì—…ë°ì´íŠ¸
                await db.collection('children').doc(childId).update({
                    arrivals: arrivals
                });
                
                alert('ğŸ“ ë„ì°© ì™„ë£Œ!\në¶€ëª¨ë‹˜ê»˜ ì•Œë¦¼ì´ ê°”ì–´ìš”!');
                
            } catch (error) {
                console.error('Mark arrived error:', error);
                alert('ë„ì°© ì•Œë¦¼ ì‹¤íŒ¨! ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }
        
        // ==========================================
        // ë³´ìƒ êµí™˜
        // ==========================================
        
        async function claimReward(rewardId) {
            if (!childData) return;
            
            const reward = childData.rewards[rewardId];
            if (!reward) return;
            
            if (childData.points < reward.points) {
                alert('í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•´ìš”!');
                return;
            }
            
            if (!confirm(\`"\${reward.name}"ì„(ë¥¼) ë°›ìœ¼ì‹œê² ì–´ìš”?\n\${reward.points}Pê°€ ì°¨ê°ë©ë‹ˆë‹¤.\`)) {
                return;
            }
            
            try {
                // Firestore ì—…ë°ì´íŠ¸
                await db.collection('children').doc(childId).update({
                    points: childData.points - reward.points
                });
                
                alert(\`ğŸ‰ ì¶•í•˜í•´ìš”!\n"\${reward.name}"ì„(ë¥¼) ë°›ì•˜ì–´ìš”!\`);
                
            } catch (error) {
                console.error('Claim reward error:', error);
                alert('ë³´ìƒ êµí™˜ ì‹¤íŒ¨! ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }
        
        // ==========================================
        // ë Œë”ë§
        // ==========================================
        
        function render() {
            if (!childData) return;
            
            document.getElementById('greeting').textContent = \`ì•ˆë…•, \${childData.name}! ğŸ’š\`;
            document.getElementById('pointsDisplay').textContent = (childData.points || 0) + 'P';
            
            const stats = AttendanceUtils.calculateRate(
                childData.academies || {}, 
                childData.attendance || {}
            );
            
            document.getElementById('attendanceRate').textContent = stats.rate + '%';
            document.getElementById('progressBar').style.width = stats.rate + '%';
            
            const milestone = AttendanceUtils.getMilestone(stats.rate);
            document.getElementById('encouragementEmoji').textContent = milestone.badge;
            document.getElementById('encouragementText').textContent = 
                AttendanceUtils.getEncouragementMessage(stats.rate);
            
            renderRewardsList();
            renderTodayAcademies();
        }
        
        function renderRewardsList() {
            const container = document.getElementById('rewardsList');
            const rewards = childData.rewards || {};
            
            if (Object.keys(rewards).length === 0) {
                container.innerHTML = \`
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ</div>
                        <div class="empty-text">ë¶€ëª¨ë‹˜ì´ ë³´ìƒì„ ë“±ë¡í•˜ë©´<br/>ì—¬ê¸°ì— ë‚˜íƒ€ë‚˜ìš”!</div>
                    </div>
                \`;
                return;
            }
            
            container.innerHTML = Object.keys(rewards).map(rewardId => {
                const reward = rewards[rewardId];
                const canClaim = childData.points >= reward.points;
                
                return \`
                    <div class="reward-card \${canClaim ? 'can-claim' : ''}">
                        <div>
                            <div class="reward-name">\${reward.name}</div>
                            <div class="reward-points">\${reward.points}P</div>
                        </div>
                        <button class="claim-btn" \${canClaim ? '' : 'disabled'} onclick="claimReward('\${rewardId}')">
                            \${canClaim ? 'ë°›ê¸°!' : 'ë¶€ì¡±'}
                        </button>
                    </div>
                \`;
            }).join('');
        }
        
        function renderTodayAcademies() {
            const container = document.getElementById('todayAcademyList');
            const todayAcademies = AlarmUtils.getTodayAcademies(childData.academies || {});
            
            if (todayAcademies.length === 0) {
                container.innerHTML = \`
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ‰</div>
                        <div class="empty-text">ì˜¤ëŠ˜ì€ í•™ì›ì´ ì—†ì–´ìš”!<br/>í‘¹ ì‰¬ì„¸ìš”!</div>
                    </div>
                \`;
                return;
            }
            
            container.innerHTML = todayAcademies.map(academy => {
                return \`
                    <div class="academy-card">
                        <div class="academy-name">\${academy.name}</div>
                        <div class="academy-info">ğŸƒ ì¶œë°œ: \${academy.departureTime}</div>
                        <div class="academy-info">ğŸ“– ìˆ˜ì—…: \${academy.classTime}</div>
                    </div>
                \`;
            }).join('');
        }
        
        // ==========================================
        // ì‹œì‘
        // ==========================================
        
        window.addEventListener('DOMContentLoaded', init);
        
        // í˜ì´ì§€ ì´íƒˆ ì‹œ êµ¬ë… í•´ì œ
        window.addEventListener('beforeunload', () => {
            if (unsubscribeChild) unsubscribeChild();
            if (alarmInterval) clearInterval(alarmInterval);
        });
    </script>
</body>
</html>
